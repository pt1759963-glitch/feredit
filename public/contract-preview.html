<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preview Hợp đồng</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 16px; background:#f7f7f7; }
    .canvas-container{ position: relative; max-width: 900px; margin: 0 auto; background: #fff; padding: 12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .canvas-loading-overlay{
      position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.85); z-index:2; font-weight:500; color:#00994F;
      flex-direction: column;
    }
    .spinner{
      width: 36px; height: 36px; border-radius:50%; border:4px solid #eee; border-top-color:#00994F; animation:spin 1s linear infinite; margin-bottom:8px;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    canvas{ display:block; width:100%; height:auto; border:1px solid #e5e7eb; background: #fff; }
    img.contract-image{ display:none; width:100%; height:auto; border:1px solid #e5e7eb; }
    .controls{ max-width:900px; margin:12px auto 0; text-align:center; }
    button, input[type=file]{ padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .note{ color:#666; font-size:13px; margin-top:8px; }
  </style>
</head>
<body>
  <h2 style="text-align:center">Xem hợp đồng</h2>

  <div class="canvas-container" aria-live="polite">
    <div class="canvas-loading-overlay" id="canvasLoadingOverlay">
      <div class="spinner" aria-hidden="true"></div>
      <div style="text-align:center; color:#00994F; font-weight:500;">Đang tải hợp đồng...</div>
    </div>

    <!-- Canvas chính (kích thước gốc: A4 300dpi tương đương 2480x3508) -->
    <canvas id="contractCanvas" width="2480" height="3508" aria-label="Hợp đồng"></canvas>

    <!-- Fallback: hiển thị image nếu cần -->
    <img id="contractImage" class="contract-image" alt="Hợp đồng (hình ảnh)">
  </div>

  <div class="controls">
    <input type="file" id="fileInput" accept="image/*" />
    <button id="useDefaultBtn" type="button">Tải ảnh mặc định từ server</button>
    <div class="note">Gợi ý: ảnh hợp đồng mặc định được lấy từ assets/img/anhhopdongvay.png</div>
  </div>

  <script>
    const canvas = document.getElementById('contractCanvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('canvasLoadingOverlay');
    const fileInput = document.getElementById('fileInput');
    const imgFallback = document.getElementById('contractImage');
    const useDefaultBtn = document.getElementById('useDefaultBtn');

    // Hàm vẽ ảnh lên canvas, giữ tỉ lệ, căn giữa
    function drawImageOnCanvas(img) {
      overlay.style.display = 'flex';
      // Clear canvas
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const cw = canvas.width, ch = canvas.height;
      const iw = img.width, ih = img.height;
      const ratioCanvas = cw / ch;
      const ratioImg = iw / ih;
      let drawW, drawH, drawX, drawY;

      if (ratioImg > ratioCanvas) {
        drawW = cw;
        drawH = Math.round(cw / ratioImg);
        drawX = 0;
        drawY = Math.round((ch - drawH)/2);
      } else {
        drawH = ch;
        drawW = Math.round(ch * ratioImg);
        drawY = 0;
        drawX = Math.round((cw - drawW)/2);
      }

      try {
        ctx.drawImage(img, drawX, drawY, drawW, drawH);
        // Ẩn fallback image (nếu có)
        imgFallback.style.display = 'none';
      } catch (e) {
        // Nếu drawImage lỗi trên trình duyệt, fallback sang <img>
        imgFallback.src = img.src;
        imgFallback.style.display = 'block';
      } finally {
        overlay.style.display = 'none';
      }
    }

    // Load ảnh từ URL (mặc định hoặc do user cung cấp)
    function loadImageToCanvas(src) {
      overlay.style.display = 'flex';
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => drawImageOnCanvas(img);
      img.onerror = () => {
        overlay.innerText = 'Không thể tải ảnh hợp đồng';
      };
      img.src = src;
    }

    // Tải ảnh mặc định từ đường dẫn trong repo (thay đổi nếu cần)
    const defaultImagePath = '/assets/img/anhhopdongvay.png';

    // Load mặc định khi mở trang
    loadImageToCanvas(defaultImagePath);

    // Cho phép người dùng upload file cục bộ để xem tạm
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      overlay.style.display = 'flex';
      const url = URL.createObjectURL(f);
      // cũng set fallback img src để có thể download/zoom nếu cần
      imgFallback.src = url;
      imgFallback.style.display = 'none';
      loadImageToCanvas(url);
      // revoke sau khi đã vẽ để tránh rò rỉ mem, đợi 1s
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    });

    useDefaultBtn.addEventListener('click', () => {
      overlay.innerHTML = '<div class="spinner" aria-hidden="true"></div><div style="text-align:center; color:#00994F; font-weight:500;">Đang tải hợp đồng...</div>';
      loadImageToCanvas(defaultImagePath);
    });

    // Hàm tiện ích để cập nhật từ SPA hoặc gọi bên ngoài: window.updateContractFromUrl(url)
    window.updateContractFromUrl = (url) => loadImageToCanvas(url);
  </script>
</body>
</html>
